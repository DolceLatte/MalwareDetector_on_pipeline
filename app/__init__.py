# __init__.py
from flask import Flask, request, jsonify

from werkzeug.utils import secure_filename

from collections import OrderedDict
import app.classifier as classifier

import os
import pefile

def create_app(classifier):
    # Flask 애플리케이션 생성
    app = Flask(__name__)
    app.config['UPLOAD_FOLDER'] = r'./file/'

    # POST / 요청을 처리하는 함수 정의
    @app.route("/Plas", methods=["POST"])
    def predict():
        # 받은 파일의 핸들러 취득
        f = request.files["file"]
        
        # 파일이 비어있는지 확인
        if f.filename == "":
            return "Bad Request", 400
   
        ext = os.path.splitext(f.filename)[0]

        #filename change
        filename = f.filename = ext

        path = os.path.join(app.config['UPLOAD_FOLDER'],secure_filename(filename))

        f.save(path)

        pe = pefile.PE(path)

        index , probability = classifier.predict(path)

        result = OrderedDict()
        result["Machine"] = hex(pe.FILE_HEADER.Machine)
        result["malware"] = index
        result["probability"] = probability[index]
        
        # 결과를 JSON 형식으로 반환
        return jsonify({
            "result": result
        })

    @app.route("/", methods=["GET"])
    def Hello():
        return jsonify({
            "result": "helloworld"
        })
    
    return app